<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Communications API Test UI</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2.5em;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1em;
    }
    .section {
      margin: 25px 0;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    .section h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.5em;
    }
    button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    input, textarea, select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
    }
    textarea {
      min-height: 100px;
      font-family: 'Courier New', monospace;
      resize: vertical;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: 600;
      color: #555;
    }
    .result {
      margin-top: 15px;
      padding: 20px;
      background: #2d2d2d;
      color: #f8f8f2;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      line-height: 1.5;
    }
    .success { color: #4caf50; font-weight: bold; }
    .error { color: #f44336; font-weight: bold; }
    .info { color: #2196f3; font-weight: bold; }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
    .status-success {
      background: #4caf50;
      color: white;
    }
    .status-error {
      background: #f44336;
      color: white;
    }
    .status-pending {
      background: #ff9800;
      color: white;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .container {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Unified Communications Test UI</h1>
    <p class="subtitle">Test interface for svc-unified-communications API</p>

    <!-- Configuration -->
    <div class="section">
      <h2>‚öôÔ∏è Configuration</h2>
      <div class="grid">
        <div>
          <label>API URL:</label>
          <input type="text" id="apiUrl" value="http://localhost:4600" />
        </div>
        <div>
          <label>WebSocket URL:</label>
          <input type="text" id="wsUrl" value="ws://localhost:4601" />
        </div>
      </div>

      <label>JWT Token (optional for health check):</label>
      <input type="password" id="jwtToken" placeholder="Paste JWT token here" />
      <small style="color: #666;">üí° Tip: Get token from svc-auth or use mock token for testing</small>
    </div>

    <!-- Quick Tests -->
    <div class="section">
      <h2>üß™ Quick Tests</h2>
      <button onclick="testHealth()">üè• Health Check</button>
      <button onclick="testApiDocs()">üìö API Docs</button>
      <button onclick="testListMessages()">üìß List Messages</button>
      <button onclick="testSettings()">‚öôÔ∏è Get Settings</button>
      <button onclick="testInbox()">üì• Get Inbox</button>
      <div id="quickResult" class="result" style="display:none;"></div>
    </div>

    <!-- Send Message -->
    <div class="section">
      <h2>üì§ Send Message</h2>

      <div class="grid">
        <div>
          <label>Channel Type:</label>
          <select id="channelType">
            <option value="email">üìß Email</option>
            <option value="sms">üì± SMS</option>
            <option value="whatsapp">üí¨ WhatsApp</option>
            <option value="telegram">‚úàÔ∏è Telegram</option>
            <option value="discord">üéÆ Discord</option>
          </select>
        </div>
        <div>
          <label>From:</label>
          <input type="text" id="fromAddress" value="test@example.com" />
        </div>
      </div>

      <label>To (comma separated):</label>
      <input type="text" id="toAddresses" value="recipient@example.com" />

      <label>Subject (email only):</label>
      <input type="text" id="subject" value="Test Message from API" />

      <label>Body:</label>
      <textarea id="body" placeholder="Message content...">Hello from the Communications Test UI!

This is a test message sent via the unified communications API.

Best regards,
Test System</textarea>

      <div style="margin-top: 15px;">
        <label style="display: inline;">
          <input type="checkbox" id="trackOpens"> Track Opens
        </label>
        <label style="display: inline; margin-left: 20px;">
          <input type="checkbox" id="trackClicks"> Track Clicks
        </label>
      </div>

      <div style="margin-top: 15px;">
        <button onclick="sendMessage()">üöÄ Send Message</button>
        <button onclick="clearForm()" style="background: #6c757d;">üóëÔ∏è Clear Form</button>
      </div>
      <div id="sendResult" class="result" style="display:none;"></div>
    </div>

    <!-- WebSocket Test -->
    <div class="section">
      <h2>üîå WebSocket Real-Time Test</h2>
      <div id="wsStatus" style="margin-bottom: 15px;">
        <span class="status-badge status-pending">‚óã Disconnected</span>
      </div>
      <button onclick="connectWebSocket()">üîó Connect WebSocket</button>
      <button onclick="disconnectWebSocket()">‚ùå Disconnect</button>
      <button onclick="clearWsMessages()" style="background: #6c757d;">üóëÔ∏è Clear Messages</button>
      <div id="wsMessages" class="result" style="display:none;">
        <span class="info">Waiting for messages...</span>
      </div>
    </div>

    <!-- System Info -->
    <div class="section">
      <h2>‚ÑπÔ∏è System Information</h2>
      <button onclick="showSystemInfo()">üìä Show Info</button>
      <div id="systemInfo" class="result" style="display:none;"></div>
    </div>
  </div>

  <script>
    let ws = null;
    let wsMessageCount = 0;

    function getApiUrl() {
      return document.getElementById('apiUrl').value;
    }

    function getToken() {
      return document.getElementById('jwtToken').value;
    }

    function showResult(elementId, data, isError = false) {
      const el = document.getElementById(elementId);
      el.style.display = 'block';
      const timestamp = new Date().toLocaleTimeString();

      if (isError) {
        el.innerHTML = `<span class="error">[${timestamp}] ERROR:</span>\n${JSON.stringify(data, null, 2)}`;
      } else {
        el.innerHTML = `<span class="success">[${timestamp}] SUCCESS:</span>\n${JSON.stringify(data, null, 2)}`;
      }

      // Scroll to result
      el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    async function testHealth() {
      try {
        const response = await fetch(`${getApiUrl()}/health`);
        const data = await response.json();
        showResult('quickResult', data);
      } catch (error) {
        showResult('quickResult', { error: error.message }, true);
      }
    }

    function testApiDocs() {
      window.open(`${getApiUrl()}/dev`, '_blank');
    }

    async function testListMessages() {
      const token = getToken();
      if (!token) {
        showResult('quickResult', { error: 'JWT token required for this endpoint' }, true);
        return;
      }

      try {
        const response = await fetch(`${getApiUrl()}/api/messages`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();
        showResult('quickResult', data, !response.ok);
      } catch (error) {
        showResult('quickResult', { error: error.message }, true);
      }
    }

    async function testSettings() {
      const token = getToken();
      if (!token) {
        showResult('quickResult', { error: 'JWT token required for this endpoint' }, true);
        return;
      }

      try {
        const response = await fetch(`${getApiUrl()}/api/settings`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();
        showResult('quickResult', data, !response.ok);
      } catch (error) {
        showResult('quickResult', { error: error.message }, true);
      }
    }

    async function testInbox() {
      const token = getToken();
      if (!token) {
        showResult('quickResult', { error: 'JWT token required for this endpoint' }, true);
        return;
      }

      try {
        const response = await fetch(`${getApiUrl()}/api/inbox`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();
        showResult('quickResult', data, !response.ok);
      } catch (error) {
        showResult('quickResult', { error: error.message }, true);
      }
    }

    async function sendMessage() {
      const token = getToken();
      if (!token) {
        showResult('sendResult', { error: 'JWT token required to send messages' }, true);
        return;
      }

      try {
        const body = {
          channel_type: document.getElementById('channelType').value,
          from: document.getElementById('fromAddress').value,
          to: document.getElementById('toAddresses').value.split(',').map(s => s.trim()),
          subject: document.getElementById('subject').value,
          body: document.getElementById('body').value,
          track_opens: document.getElementById('trackOpens').checked,
          track_clicks: document.getElementById('trackClicks').checked
        };

        const response = await fetch(`${getApiUrl()}/api/messages`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        const data = await response.json();
        showResult('sendResult', data, !response.ok);
      } catch (error) {
        showResult('sendResult', { error: error.message }, true);
      }
    }

    function clearForm() {
      document.getElementById('toAddresses').value = 'recipient@example.com';
      document.getElementById('subject').value = 'Test Message from API';
      document.getElementById('body').value = 'Hello from the Communications Test UI!';
      document.getElementById('trackOpens').checked = false;
      document.getElementById('trackClicks').checked = false;
      document.getElementById('sendResult').style.display = 'none';
    }

    function connectWebSocket() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        alert('WebSocket already connected!');
        return;
      }

      const wsUrl = document.getElementById('wsUrl').value;
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        document.getElementById('wsStatus').innerHTML =
          '<span class="status-badge status-success">‚úì Connected</span>';
        document.getElementById('wsMessages').style.display = 'block';
        wsMessageCount = 0;
        addWsMessage('System', 'WebSocket connection established', 'info');
      };

      ws.onmessage = (event) => {
        wsMessageCount++;
        try {
          const data = JSON.parse(event.data);
          addWsMessage('Server', JSON.stringify(data, null, 2), 'success');
        } catch {
          addWsMessage('Server', event.data, 'success');
        }
      };

      ws.onerror = (error) => {
        document.getElementById('wsStatus').innerHTML =
          '<span class="status-badge status-error">‚úó Error</span>';
        addWsMessage('System', 'WebSocket error occurred', 'error');
      };

      ws.onclose = () => {
        document.getElementById('wsStatus').innerHTML =
          '<span class="status-badge status-pending">‚óã Disconnected</span>';
        addWsMessage('System', 'WebSocket connection closed', 'info');
        ws = null;
      };
    }

    function disconnectWebSocket() {
      if (ws) {
        ws.close();
        ws = null;
      } else {
        alert('No active WebSocket connection');
      }
    }

    function addWsMessage(source, message, type) {
      const el = document.getElementById('wsMessages');
      const timestamp = new Date().toLocaleTimeString();
      const typeClass = type === 'error' ? 'error' : (type === 'info' ? 'info' : 'success');

      const newMessage = `<span class="${typeClass}">[${timestamp}] ${source}:</span> ${message}\n\n`;

      if (el.innerHTML.includes('Waiting for messages')) {
        el.innerHTML = newMessage;
      } else {
        el.innerHTML += newMessage;
      }

      // Auto scroll to bottom
      el.scrollTop = el.scrollHeight;
    }

    function clearWsMessages() {
      document.getElementById('wsMessages').innerHTML =
        '<span class="info">Messages cleared. Waiting for new messages...</span>';
      wsMessageCount = 0;
    }

    function showSystemInfo() {
      const info = {
        browser: {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language
        },
        screen: {
          width: screen.width,
          height: screen.height,
          colorDepth: screen.colorDepth
        },
        api: {
          baseUrl: getApiUrl(),
          wsUrl: document.getElementById('wsUrl').value,
          hasToken: !!getToken()
        },
        timestamp: new Date().toISOString()
      };

      showResult('systemInfo', info);
    }

    // Auto-test health on load
    window.onload = () => {
      console.log('üöÄ Communications Test UI loaded');
      console.log('API URL:', getApiUrl());
      testHealth();
    };

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendMessage();
        }
      }
    });
  </script>
</body>
</html>
