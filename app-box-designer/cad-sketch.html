<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Box Designer CAD Studio Pro</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="cad-engine.js"></script>
  <style>
    :root {
      --bg-primary: #1e1e1e;
      --bg-secondary: #252526;
      --bg-tertiary: #2d2d30;
      --bg-hover: #37373d;
      --border-color: #3e3e42;
      --text-primary: #cccccc;
      --text-secondary: #858585;
      --accent-blue: #0e7afe;
      --accent-blue-hover: #1f8bff;
      --accent-green: #16c60c;
      --accent-red: #f85149;
      --accent-orange: #ff9500;
      --line-cut: #ff4444;
      --line-crease: #4488ff;
      --line-perforation: #ff44ff;
      --line-bleed: #44ff44;
      --shadow: 0 4px 12px rgba(0,0,0,0.3);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.4);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', 'Roboto', Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow: hidden;
      height: 100vh;
    }

    /* Top Header */
    .header {
      height: 56px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      padding: 0 16px;
      justify-content: space-between;
      box-shadow: var(--shadow);
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 15px;
      color: var(--text-primary);
    }

    .logo i {
      font-size: 24px;
      color: var(--accent-blue);
    }

    .project-name {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .project-name:hover {
      background: var(--bg-hover);
    }

    .header-center {
      display: flex;
      gap: 4px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Toolbar */
    .toolbar {
      height: 48px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 8px;
      overflow-x: auto;
      overflow-y: hidden;
    }

    .toolbar-group {
      display: flex;
      gap: 4px;
      padding: 0 8px;
      border-right: 1px solid var(--border-color);
    }

    .toolbar-group:last-child {
      border-right: none;
      margin-left: auto;
    }

    .tool-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-primary);
      font-size: 16px;
      position: relative;
    }

    .tool-btn:hover {
      background: var(--bg-hover);
      border-color: var(--border-color);
    }

    .tool-btn.active {
      background: var(--accent-blue);
      color: white;
    }

    .tool-btn-wide {
      width: auto;
      padding: 0 12px;
      gap: 6px;
      font-size: 13px;
    }

    .tool-btn-wide span {
      font-size: 13px;
    }

    /* Main Layout */
    .main-container {
      display: flex;
      height: calc(100vh - 56px - 48px - 32px);
    }

    /* Left Sidebar */
    .left-sidebar {
      width: 260px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-tabs {
      display: flex;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-tab {
      flex: 1;
      padding: 10px 8px;
      text-align: center;
      cursor: pointer;
      font-size: 12px;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      color: var(--text-secondary);
    }

    .sidebar-tab.active {
      border-bottom-color: var(--accent-blue);
      color: var(--text-primary);
      background: var(--bg-secondary);
    }

    .sidebar-tab:hover {
      background: var(--bg-hover);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    /* Panel Sections */
    .panel-section {
      margin-bottom: 16px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 8px 8px 0;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      user-select: none;
    }

    .panel-header:hover {
      color: var(--text-primary);
    }

    .panel-header i {
      transition: transform 0.2s;
    }

    .panel-section.collapsed .panel-header i {
      transform: rotate(-90deg);
    }

    .panel-body {
      padding: 8px 0;
    }

    .panel-section.collapsed .panel-body {
      display: none;
    }

    /* Tool Items */
    .tool-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 4px;
    }

    .tool-item:hover {
      background: var(--bg-hover);
    }

    .tool-item.active {
      background: var(--accent-blue);
      color: white;
    }

    .tool-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border-radius: 6px;
      font-size: 16px;
    }

    .tool-item.active .tool-icon {
      background: rgba(255,255,255,0.2);
    }

    .line-type-indicator {
      width: 24px;
      height: 3px;
      border-radius: 2px;
    }

    .line-cut { background: var(--line-cut); }
    .line-crease {
      background: repeating-linear-gradient(
        90deg,
        var(--line-crease),
        var(--line-crease) 5px,
        transparent 5px,
        transparent 10px
      );
      height: 2px;
    }
    .line-perforation {
      background: repeating-linear-gradient(
        90deg,
        var(--line-perforation),
        var(--line-perforation) 2px,
        transparent 2px,
        transparent 5px
      );
      height: 2px;
    }
    .line-bleed { background: var(--line-bleed); height: 1px; }

    .tool-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .tool-name {
      font-size: 13px;
      font-weight: 500;
    }

    .tool-shortcut {
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* Property Input */
    .property-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      margin-bottom: 6px;
      background: var(--bg-tertiary);
      border-radius: 6px;
    }

    .property-label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .property-value {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .property-input {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 4px 8px;
      color: var(--text-primary);
      font-size: 12px;
      width: 80px;
      text-align: right;
    }

    .property-input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .toggle-switch {
      width: 36px;
      height: 20px;
      background: var(--bg-primary);
      border-radius: 10px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle-switch.active {
      background: var(--accent-blue);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: left 0.2s;
    }

    .toggle-switch.active::after {
      left: 18px;
    }

    /* Canvas Area */
    .canvas-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-primary);
      position: relative;
      overflow: hidden;
    }

    .canvas-wrapper {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    canvas {
      display: block;
      cursor: crosshair;
      background: #1a1a1a;
    }

    /* Right Sidebar */
    .right-sidebar {
      width: 280px;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .layers-header {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
    }

    .layers-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .layer-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 4px;
      background: var(--bg-tertiary);
    }

    .layer-item:hover {
      background: var(--bg-hover);
    }

    .layer-item.selected {
      background: var(--accent-blue);
      color: white;
    }

    .layer-visibility {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      opacity: 0.6;
    }

    .layer-visibility:hover {
      opacity: 1;
    }

    .layer-name {
      flex: 1;
      font-size: 13px;
    }

    .layer-count {
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* Status Bar */
    .status-bar {
      height: 32px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 20px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-separator {
      width: 1px;
      height: 16px;
      background: var(--border-color);
    }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--accent-blue);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-blue-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .btn-success {
      background: var(--accent-green);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .btn-danger {
      background: var(--accent-red);
      color: white;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-color);
    }

    .modal-header {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .modal-body {
      margin-bottom: 20px;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-hover);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-color);
    }

    /* Tooltip */
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: -32px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 11px;
      white-space: nowrap;
      z-index: 1000;
      box-shadow: var(--shadow);
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }

    .stat-card {
      background: var(--bg-tertiary);
      padding: 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .stat-unit {
      font-size: 12px;
      color: var(--text-secondary);
      margin-left: 2px;
    }

    /* Zoom Controls */
    .zoom-controls {
      position: absolute;
      bottom: 16px;
      right: 16px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px;
      box-shadow: var(--shadow);
    }

    .zoom-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-primary);
    }

    .zoom-btn:hover {
      background: var(--bg-hover);
      transform: scale(1.05);
    }

    .zoom-level {
      padding: 4px 8px;
      text-align: center;
      font-size: 11px;
      color: var(--text-secondary);
      user-select: none;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <i class="fas fa-cube"></i>
        <span>Box Designer CAD Studio</span>
      </div>
      <div class="project-name" onclick="openSaveModal()">
        <i class="fas fa-file"></i>
        <span id="projectNameDisplay">Untitled Project</span>
        <i class="fas fa-chevron-down" style="font-size: 10px; color: var(--text-secondary);"></i>
      </div>
    </div>

    <div class="header-center">
      <button class="btn btn-secondary" onclick="undo()">
        <i class="fas fa-undo"></i> Undo
      </button>
      <button class="btn btn-secondary" onclick="redo()">
        <i class="fas fa-redo"></i> Redo
      </button>
    </div>

    <div class="header-right">
      <button class="btn btn-secondary" onclick="exportJSON()">
        <i class="fas fa-file-export"></i> Export
      </button>
      <button class="btn btn-success" onclick="openSaveModal()">
        <i class="fas fa-save"></i> Save Template
      </button>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-group">
      <button class="tool-btn active" data-tool="select" data-tooltip="Select (V)" onclick="setTool('select')">
        <i class="fas fa-mouse-pointer"></i>
      </button>
      <button class="tool-btn" data-tool="hand" data-tooltip="Hand (H)" onclick="setTool('hand')">
        <i class="fas fa-hand-paper"></i>
      </button>
    </div>

    <div class="toolbar-group">
      <button class="tool-btn" data-tool="line" data-tooltip="Line (L)" onclick="setTool('line')">
        <i class="fas fa-slash"></i>
      </button>
      <button class="tool-btn" data-tool="rectangle" data-tooltip="Rectangle (R)" onclick="setTool('rectangle')">
        <i class="fas fa-square"></i>
      </button>
      <button class="tool-btn" data-tool="circle" data-tooltip="Circle (C)" onclick="setTool('circle')">
        <i class="fas fa-circle"></i>
      </button>
      <button class="tool-btn" data-tool="polygon" data-tooltip="Polygon (P)" onclick="setTool('polygon')">
        <i class="fas fa-draw-polygon"></i>
      </button>
    </div>

    <div class="toolbar-group">
      <button class="tool-btn tool-btn-wide" onclick="finishLine()">
        <i class="fas fa-check"></i>
        <span>Finish</span>
      </button>
      <button class="tool-btn tool-btn-wide" onclick="closeShape()">
        <i class="fas fa-circle-notch"></i>
        <span>Close</span>
      </button>
    </div>

    <div class="toolbar-group">
      <button class="tool-btn" data-tooltip="Snap to Grid (Ctrl+G)" onclick="toggleSnap()">
        <i class="fas fa-magnet" id="snapIcon"></i>
      </button>
      <button class="tool-btn" data-tooltip="Show Grid (Ctrl+;)" onclick="toggleGrid()">
        <i class="fas fa-th" id="gridIcon"></i>
      </button>
      <button class="tool-btn" data-tooltip="Show Rulers" onclick="toggleRulers()">
        <i class="fas fa-ruler-combined"></i>
      </button>
    </div>

    <div class="toolbar-group">
      <span style="font-size: 12px; color: var(--text-secondary); padding: 0 8px;">Zoom:</span>
      <button class="tool-btn" onclick="zoomOut()">
        <i class="fas fa-search-minus"></i>
      </button>
      <span id="zoomDisplay" style="font-size: 12px; min-width: 50px; text-align: center;">100%</span>
      <button class="tool-btn" onclick="zoomIn()">
        <i class="fas fa-search-plus"></i>
      </button>
      <button class="tool-btn" onclick="zoomFit()">
        <i class="fas fa-compress-arrows-alt"></i>
      </button>
    </div>

    <div class="toolbar-group">
      <button class="tool-btn btn-danger" data-tooltip="Clear All" onclick="clearAll()">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Left Sidebar -->
    <div class="left-sidebar">
      <div class="sidebar-tabs">
        <div class="sidebar-tab active" onclick="switchTab('tools')">
          <i class="fas fa-tools"></i> Tools
        </div>
        <div class="sidebar-tab" onclick="switchTab('templates')">
          <i class="fas fa-th-large"></i> Templates
        </div>
        <div class="sidebar-tab" onclick="switchTab('properties')">
          <i class="fas fa-sliders-h"></i> Properties
        </div>
      </div>

      <div class="sidebar-content" id="toolsTab">
        <!-- Line Types -->
        <div class="panel-section">
          <div class="panel-header" onclick="togglePanel(this)">
            <span><i class="fas fa-pencil-alt"></i> Line Types</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="panel-body">
            <div class="tool-item active" onclick="setLineType('cut')">
              <div class="tool-icon">
                <div class="line-type-indicator line-cut"></div>
              </div>
              <div class="tool-info">
                <div class="tool-name">Cut Line</div>
                <div class="tool-shortcut">Ctrl+1</div>
              </div>
            </div>
            <div class="tool-item" onclick="setLineType('crease')">
              <div class="tool-icon">
                <div class="line-type-indicator line-crease"></div>
              </div>
              <div class="tool-info">
                <div class="tool-name">Crease Line</div>
                <div class="tool-shortcut">Ctrl+2</div>
              </div>
            </div>
            <div class="tool-item" onclick="setLineType('perforation')">
              <div class="tool-icon">
                <div class="line-type-indicator line-perforation"></div>
              </div>
              <div class="tool-info">
                <div class="tool-name">Perforation</div>
                <div class="tool-shortcut">Ctrl+3</div>
              </div>
            </div>
            <div class="tool-item" onclick="setLineType('bleed')">
              <div class="tool-icon">
                <div class="line-type-indicator line-bleed"></div>
              </div>
              <div class="tool-info">
                <div class="tool-name">Bleed Line</div>
                <div class="tool-shortcut">Ctrl+4</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Grid Settings -->
        <div class="panel-section">
          <div class="panel-header" onclick="togglePanel(this)">
            <span><i class="fas fa-th"></i> Grid Settings</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="panel-body">
            <div class="property-row">
              <span class="property-label">Grid Size</span>
              <input type="number" class="property-input" id="gridSizeInput" value="10" min="1" max="100" onchange="updateGridSize(this.value)">
            </div>
            <div class="property-row">
              <span class="property-label">Snap to Grid</span>
              <div class="toggle-switch active" id="snapToggle" onclick="toggleSnap()"></div>
            </div>
            <div class="property-row">
              <span class="property-label">Show Grid</span>
              <div class="toggle-switch active" id="gridToggle" onclick="toggleGrid()"></div>
            </div>
          </div>
        </div>

        <!-- Statistics -->
        <div class="panel-section">
          <div class="panel-header" onclick="togglePanel(this)">
            <span><i class="fas fa-chart-bar"></i> Statistics</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="panel-body">
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Lines</div>
                <div class="stat-value" id="totalLinesDisplay">0</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Points</div>
                <div class="stat-value" id="totalPointsDisplay">0</div>
              </div>
            </div>
            <div class="property-row">
              <span class="property-label">Dimensions</span>
              <span class="property-value" id="dimensionsDisplay">-</span>
            </div>
            <div class="property-row">
              <span class="property-label">Area</span>
              <span class="property-value" id="areaDisplay">-</span>
            </div>
          </div>
        </div>
      </div>

      <div class="sidebar-content" id="templatesTab" style="display: none;">
        <!-- Template Library -->
        <div class="panel-section">
          <div class="panel-header" onclick="togglePanel(this)">
            <span><i class="fas fa-box"></i> Standard FEFCO</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="panel-body" id="templatesList">
            <!-- Populated dynamically -->
          </div>
        </div>

        <!-- Template Parameters -->
        <div class="panel-section">
          <div class="panel-header" onclick="togglePanel(this)">
            <span><i class="fas fa-cog"></i> Parameters</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="panel-body" id="templateParams">
            <p style="font-size: 12px; color: var(--text-secondary); padding: 10px;">
              Select a template to edit parameters
            </p>
          </div>
        </div>
      </div>

      <div class="sidebar-content" id="propertiesTab" style="display: none;">
        <div class="panel-section">
          <div class="panel-header" onclick="togglePanel(this)">
            <span><i class="fas fa-info-circle"></i> Selection</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="panel-body">
            <p style="font-size: 12px; color: var(--text-secondary); padding: 10px;">
              No object selected
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Canvas Area -->
    <div class="canvas-area">
      <div class="canvas-wrapper">
        <canvas id="canvas"></canvas>

        <!-- Zoom Controls -->
        <div class="zoom-controls">
          <div class="zoom-btn" onclick="zoomIn()">
            <i class="fas fa-plus"></i>
          </div>
          <div class="zoom-level" id="zoomLevelDisplay">100%</div>
          <div class="zoom-btn" onclick="zoomOut()">
            <i class="fas fa-minus"></i>
          </div>
          <div class="zoom-btn" onclick="zoomFit()">
            <i class="fas fa-expand"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="right-sidebar">
      <div class="layers-header">
        <i class="fas fa-layer-group"></i> Layers
      </div>
      <div class="layers-list">
        <div class="layer-item selected">
          <div class="layer-visibility">
            <i class="fas fa-eye"></i>
          </div>
          <div class="layer-name">Cut Lines</div>
          <div class="layer-count" id="cutLinesCount">0</div>
        </div>
        <div class="layer-item">
          <div class="layer-visibility">
            <i class="fas fa-eye"></i>
          </div>
          <div class="layer-name">Crease Lines</div>
          <div class="layer-count" id="creaseLinesCount">0</div>
        </div>
        <div class="layer-item">
          <div class="layer-visibility">
            <i class="fas fa-eye"></i>
          </div>
          <div class="layer-name">Perforations</div>
          <div class="layer-count" id="perforationLinesCount">0</div>
        </div>
        <div class="layer-item">
          <div class="layer-visibility">
            <i class="fas fa-eye"></i>
          </div>
          <div class="layer-name">Bleed Lines</div>
          <div class="layer-count" id="bleedLinesCount">0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <div class="status-item">
      <i class="fas fa-mouse-pointer"></i>
      <span id="cursorPosition">X: 0, Y: 0</span>
    </div>
    <div class="status-separator"></div>
    <div class="status-item">
      <i class="fas fa-pencil-alt"></i>
      <span id="currentToolDisplay">Line Tool</span>
    </div>
    <div class="status-separator"></div>
    <div class="status-item">
      <i class="fas fa-palette"></i>
      <span id="currentLineTypeDisplay">Cut Line</span>
    </div>
    <div class="status-separator"></div>
    <div class="status-item">
      <i class="fas fa-info-circle"></i>
      <span id="statusMessage">Ready</span>
    </div>
  </div>

  <!-- Save Modal -->
  <div class="modal" id="saveModal">
    <div class="modal-content">
      <div class="modal-header">
        <i class="fas fa-save"></i> Save Template
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Template Name</label>
          <input type="text" class="form-input" id="templateNameInput" placeholder="Enter template name...">
        </div>
        <div class="form-group">
          <label class="form-label">Description (Optional)</label>
          <input type="text" class="form-input" id="templateDescInput" placeholder="Enter description...">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSaveModal()">Cancel</button>
        <button class="btn btn-success" onclick="saveTemplate()">
          <i class="fas fa-check"></i> Save
        </button>
      </div>
    </div>
  </div>

  <script>
    // Canvas setup
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // State
    let lines = [];
    let currentPoints = [];
    let currentTool = 'line';
    let currentLineType = 'cut';
    let snapToGrid = true;
    let showGrid = true;
    let gridSize = 10;
    let zoom = 1;
    let pan = { x: 0, y: 0 };
    let offset = { x: 50, y: 50 };
    let projectName = 'Untitled Project';
    let history = [];
    let historyIndex = -1;

    // Resize canvas to fill container
    function resizeCanvas() {
      const wrapper = canvas.parentElement;
      canvas.width = wrapper.clientWidth;
      canvas.height = wrapper.clientHeight;
      render();
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Snap point to grid
    function snapPoint(p) {
      if (!snapToGrid) return p;
      return {
        x: Math.round(p.x / gridSize) * gridSize,
        y: Math.round(p.y / gridSize) * gridSize
      };
    }

    // Draw grid
    function drawGrid() {
      if (!showGrid) return;

      ctx.save();
      ctx.translate(offset.x + pan.x, offset.y + pan.y);
      ctx.scale(zoom, zoom);

      // Fine grid
      ctx.strokeStyle = 'rgba(255,255,255,0.05)';
      ctx.lineWidth = 0.5 / zoom;
      for (let x = 0; x <= 2000; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, 2000);
        ctx.stroke();
      }
      for (let y = 0; y <= 2000; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(2000, y);
        ctx.stroke();
      }

      // Major grid
      ctx.strokeStyle = 'rgba(255,255,255,0.1)';
      ctx.lineWidth = 1 / zoom;
      for (let x = 0; x <= 2000; x += 100) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, 2000);
        ctx.stroke();
      }
      for (let y = 0; y <= 2000; y += 100) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(2000, y);
        ctx.stroke();
      }

      // Axes
      ctx.strokeStyle = 'rgba(255,255,255,0.2)';
      ctx.lineWidth = 2 / zoom;
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(2000, 0);
      ctx.moveTo(0, 0);
      ctx.lineTo(0, 2000);
      ctx.stroke();

      ctx.restore();
    }

    // Draw line
    function drawLine(line) {
      if (line.points.length < 1) return;

      ctx.save();
      ctx.translate(offset.x + pan.x, offset.y + pan.y);
      ctx.scale(zoom, zoom);

      // Line style
      const styles = {
        cut: { color: '#ff4444', width: 2, dash: [] },
        crease: { color: '#4488ff', width: 1.5, dash: [5, 5] },
        perforation: { color: '#ff44ff', width: 1.5, dash: [2, 3] },
        bleed: { color: '#44ff44', width: 1, dash: [] }
      };

      const style = styles[line.type] || styles.cut;
      ctx.strokeStyle = style.color;
      ctx.lineWidth = style.width / zoom;
      ctx.setLineDash(style.dash);

      // Draw path
      if (line.points.length >= 2) {
        ctx.beginPath();
        ctx.moveTo(line.points[0].x, line.points[0].y);
        for (let i = 1; i < line.points.length; i++) {
          ctx.lineTo(line.points[i].x, line.points[i].y);
        }
        if (line.closed) ctx.closePath();
        ctx.stroke();
      }

      // Draw points
      ctx.fillStyle = style.color;
      ctx.setLineDash([]);
      for (const p of line.points) {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 4 / zoom, 0, Math.PI * 2);
        ctx.fill();
      }

      ctx.restore();
    }

    // Render
    function render() {
      ctx.fillStyle = '#1a1a1a';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      drawGrid();

      for (const line of lines) {
        drawLine(line);
      }

      if (currentPoints.length > 0) {
        drawLine({
          type: currentLineType,
          points: currentPoints,
          closed: false
        });
      }

      // Preview for shape tools
      if (drawingStart && currentMousePos) {
        ctx.save();
        ctx.globalAlpha = 0.5;

        if (currentTool === 'rectangle') {
          const previewRect = window.CADEngine.CADTools.createRectangle(
            Math.min(drawingStart.x, currentMousePos.x),
            Math.min(drawingStart.y, currentMousePos.y),
            Math.abs(currentMousePos.x - drawingStart.x),
            Math.abs(currentMousePos.y - drawingStart.y),
            currentLineType
          );
          drawLine(previewRect);
        } else if (currentTool === 'circle') {
          const dx = currentMousePos.x - drawingStart.x;
          const dy = currentMousePos.y - drawingStart.y;
          const radius = Math.sqrt(dx * dx + dy * dy);
          const previewCircle = window.CADEngine.CADTools.createCircle(
            drawingStart.x,
            drawingStart.y,
            radius,
            currentLineType
          );
          drawLine(previewCircle);
        }

        ctx.restore();
      }

      updateUI();
    }

    // Update UI
    function updateUI() {
      // Count by type
      const counts = { cut: 0, crease: 0, perforation: 0, bleed: 0 };
      let totalPoints = 0;
      lines.forEach(line => {
        counts[line.type]++;
        totalPoints += line.points.length;
      });

      document.getElementById('cutLinesCount').textContent = counts.cut;
      document.getElementById('creaseLinesCount').textContent = counts.crease;
      document.getElementById('perforationLinesCount').textContent = counts.perforation;
      document.getElementById('bleedLinesCount').textContent = counts.bleed;
      document.getElementById('totalLinesDisplay').textContent = lines.length;
      document.getElementById('totalPointsDisplay').textContent = totalPoints + currentPoints.length;

      // Dimensions
      if (lines.length > 0) {
        const bounds = calculateBounds();
        document.getElementById('dimensionsDisplay').textContent =
          `${bounds.width} × ${bounds.height} mm`;
        document.getElementById('areaDisplay').textContent =
          `${((bounds.width * bounds.height) / 100).toFixed(2)} cm²`;
      } else {
        document.getElementById('dimensionsDisplay').textContent = '-';
        document.getElementById('areaDisplay').textContent = '-';
      }

      // Zoom
      document.getElementById('zoomDisplay').textContent = Math.round(zoom * 100) + '%';
      document.getElementById('zoomLevelDisplay').textContent = Math.round(zoom * 100) + '%';

      // Snap/Grid icons
      document.getElementById('snapIcon').style.color = snapToGrid ? 'var(--accent-blue)' : 'var(--text-primary)';
      document.getElementById('gridIcon').style.color = showGrid ? 'var(--accent-blue)' : 'var(--text-primary)';
    }

    // Drawing state for advanced tools
    let drawingStart = null;

    // Canvas click
    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const point = snapPoint({
        x: (e.clientX - rect.left - offset.x - pan.x) / zoom,
        y: (e.clientY - rect.top - offset.y - pan.y) / zoom
      });

      // Handle different tools
      switch(currentTool) {
        case 'line':
        case 'polygon':
          currentPoints.push(point);
          saveHistory();
          render();
          updateStatus(`Point added at (${Math.round(point.x)}, ${Math.round(point.y)})`);
          break;

        case 'rectangle':
          if (!drawingStart) {
            drawingStart = point;
            updateStatus('Click to set opposite corner');
          } else {
            const rect = window.CADEngine.CADTools.createRectangle(
              Math.min(drawingStart.x, point.x),
              Math.min(drawingStart.y, point.y),
              Math.abs(point.x - drawingStart.x),
              Math.abs(point.y - drawingStart.y),
              currentLineType
            );
            lines.push({ ...rect, id: `line-${Date.now()}` });
            drawingStart = null;
            saveHistory();
            render();
            updateStatus(`Rectangle created (${Math.abs(point.x - drawingStart.x).toFixed(0)} × ${Math.abs(point.y - drawingStart.y).toFixed(0)}mm)`);
          }
          break;

        case 'circle':
          if (!drawingStart) {
            drawingStart = point;
            updateStatus('Click to set radius');
          } else {
            const dx = point.x - drawingStart.x;
            const dy = point.y - drawingStart.y;
            const radius = Math.sqrt(dx * dx + dy * dy);
            const circle = window.CADEngine.CADTools.createCircle(
              drawingStart.x,
              drawingStart.y,
              radius,
              currentLineType
            );
            lines.push({ ...circle, id: `line-${Date.now()}` });
            drawingStart = null;
            saveHistory();
            render();
            updateStatus(`Circle created (radius ${radius.toFixed(0)}mm)`);
          }
          break;
      }
    });

    // Mouse move for cursor position and preview
    let currentMousePos = null;

    canvas.addEventListener('mousemove', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = Math.round((e.clientX - rect.left - offset.x - pan.x) / zoom);
      const y = Math.round((e.clientY - rect.top - offset.y - pan.y) / zoom);

      currentMousePos = snapPoint({ x, y });
      document.getElementById('cursorPosition').textContent = `X: ${x}, Y: ${y}`;

      // Show preview for shape tools
      if (drawingStart && (currentTool === 'rectangle' || currentTool === 'circle')) {
        render();
      }
    });

    // Tools
    function setTool(tool) {
      currentTool = tool;
      document.querySelectorAll('[data-tool]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tool === tool);
      });
      document.getElementById('currentToolDisplay').textContent =
        tool.charAt(0).toUpperCase() + tool.slice(1) + ' Tool';
      updateStatus(`Switched to ${tool} tool`);
    }

    function setLineType(type) {
      currentLineType = type;
      document.querySelectorAll('.tool-item').forEach(item => {
        item.classList.remove('active');
      });
      event.currentTarget.classList.add('active');

      const names = { cut: 'Cut Line', crease: 'Crease Line', perforation: 'Perforation', bleed: 'Bleed Line' };
      document.getElementById('currentLineTypeDisplay').textContent = names[type];
      updateStatus(`Changed line type to ${names[type]}`);
    }

    function finishLine() {
      if (currentPoints.length < 2) {
        currentPoints = [];
        return;
      }

      lines.push({
        id: `line-${Date.now()}`,
        type: currentLineType,
        points: [...currentPoints],
        closed: false
      });

      currentPoints = [];
      saveHistory();
      render();
      updateStatus(`Line completed (${lines.length} total lines)`);
    }

    function closeShape() {
      if (currentPoints.length < 3) return;

      lines.push({
        id: `line-${Date.now()}`,
        type: currentLineType,
        points: [...currentPoints],
        closed: true
      });

      currentPoints = [];
      saveHistory();
      render();
      updateStatus('Shape closed');
    }

    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        lines = JSON.parse(JSON.stringify(history[historyIndex]));
        render();
        updateStatus('Undo');
      }
    }

    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        lines = JSON.parse(JSON.stringify(history[historyIndex]));
        render();
        updateStatus('Redo');
      }
    }

    function saveHistory() {
      history = history.slice(0, historyIndex + 1);
      history.push(JSON.parse(JSON.stringify(lines)));
      historyIndex++;
      if (history.length > 50) {
        history.shift();
        historyIndex--;
      }
    }

    function clearAll() {
      if (confirm('Delete all lines? This cannot be undone.')) {
        lines = [];
        currentPoints = [];
        saveHistory();
        render();
        updateStatus('All lines cleared');
      }
    }

    // Grid/Snap
    function toggleSnap() {
      snapToGrid = !snapToGrid;
      document.getElementById('snapToggle').classList.toggle('active', snapToGrid);
      render();
      updateStatus(`Snap to grid ${snapToGrid ? 'enabled' : 'disabled'}`);
    }

    function toggleGrid() {
      showGrid = !showGrid;
      document.getElementById('gridToggle').classList.toggle('active', showGrid);
      render();
      updateStatus(`Grid ${showGrid ? 'shown' : 'hidden'}`);
    }

    function updateGridSize(value) {
      gridSize = parseInt(value) || 10;
      render();
      updateStatus(`Grid size: ${gridSize}mm`);
    }

    function toggleRulers() {
      updateStatus('Rulers not yet implemented');
    }

    // Zoom
    function zoomIn() {
      zoom = Math.min(zoom * 1.2, 10);
      render();
    }

    function zoomOut() {
      zoom = Math.max(zoom / 1.2, 0.1);
      render();
    }

    function zoomFit() {
      zoom = 1;
      pan = { x: 0, y: 0 };
      render();
      updateStatus('Zoom reset to 100%');
    }

    // Panels
    function togglePanel(header) {
      header.parentElement.classList.toggle('collapsed');
    }

    function switchTab(tab) {
      document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
      event.currentTarget.classList.add('active');

      document.getElementById('toolsTab').style.display = tab === 'tools' ? 'block' : 'none';
      document.getElementById('templatesTab').style.display = tab === 'templates' ? 'block' : 'none';
      document.getElementById('propertiesTab').style.display = tab === 'properties' ? 'block' : 'none';

      if (tab === 'templates') {
        populateTemplates();
      }
    }

    // Template System
    let currentTemplate = null;
    let currentTemplateParams = null;

    function populateTemplates() {
      const container = document.getElementById('templatesList');
      container.innerHTML = '';

      Object.entries(window.CADEngine.TemplateLibrary).forEach(([key, template]) => {
        const item = document.createElement('div');
        item.className = 'tool-item';
        item.onclick = () => selectTemplate(key, template);
        item.innerHTML = `
          <div class="tool-icon">
            <i class="fas fa-cube"></i>
          </div>
          <div class="tool-info">
            <div class="tool-name">${template.name}</div>
            <div class="tool-shortcut">FEFCO ${template.fefco}</div>
          </div>
        `;
        container.appendChild(item);
      });
    }

    function selectTemplate(key, template) {
      currentTemplate = key;
      currentTemplateParams = { ...template.defaultParams };

      // Highlight selected
      document.querySelectorAll('#templatesList .tool-item').forEach(item => {
        item.classList.remove('active');
      });
      event.currentTarget.classList.add('active');

      // Show parameters
      const paramsContainer = document.getElementById('templateParams');
      paramsContainer.innerHTML = '';

      Object.entries(currentTemplateParams).forEach(([param, value]) => {
        const row = document.createElement('div');
        row.className = 'property-row';
        row.innerHTML = `
          <span class="property-label">${param}</span>
          <input type="number" class="property-input" id="param-${param}" value="${value}"
                 onchange="updateTemplateParam('${param}', this.value)">
        `;
        paramsContainer.appendChild(row);
      });

      // Add generate button
      const btnDiv = document.createElement('div');
      btnDiv.style.padding = '10px 0';
      btnDiv.innerHTML = `
        <button class="btn btn-primary" style="width: 100%;" onclick="generateTemplate()">
          <i class="fas fa-plus"></i> Generate
        </button>
      `;
      paramsContainer.appendChild(btnDiv);

      updateStatus(`Selected: ${template.name}`);
    }

    function updateTemplateParam(param, value) {
      currentTemplateParams[param] = parseFloat(value) || 0;
    }

    function generateTemplate() {
      if (!currentTemplate) return;

      const template = window.CADEngine.TemplateLibrary[currentTemplate];
      const generator = new template.generator(currentTemplateParams);
      const generatedLines = generator.generate();

      // Clear current drawing
      lines = [];
      currentPoints = [];

      // Add generated lines
      generatedLines.forEach(line => {
        lines.push({
          ...line,
          id: `line-${Date.now()}-${Math.random()}`
        });
      });

      saveHistory();
      render();
      updateStatus(`✓ Generated ${template.name} (${lines.length} lines)`);

      // Switch to tools tab to see result
      switchTab('tools');
      document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.sidebar-tab')[0].classList.add('active');
    }

    // Save/Export
    function openSaveModal() {
      document.getElementById('saveModal').classList.add('active');
      document.getElementById('templateNameInput').value = projectName;
      document.getElementById('templateNameInput').focus();
    }

    function closeSaveModal() {
      document.getElementById('saveModal').classList.remove('active');
    }

    async function saveTemplate() {
      const name = document.getElementById('templateNameInput').value || 'Untitled';
      const description = document.getElementById('templateDescInput').value || 'CAD manual drawing';

      const templateData = {
        name,
        description,
        category: 'custom',
        base_config: {
          type: 'custom',
          dimensions: lines.length > 0 ? calculateBounds() : {},
        },
        dieline: {
          lines,
          version: '2.0',
          units: 'mm',
          metadata: {
            created: new Date().toISOString(),
            tool: 'Box Designer CAD Studio Pro'
          }
        },
        preview_svg: generatePreviewSVG(),
        is_public: false,
      };

      try {
        const response = await fetch('http://localhost:5850/api/box/templates', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer dev-token',
          },
          body: JSON.stringify(templateData),
        });

        if (response.ok) {
          const result = await response.json();
          projectName = name;
          document.getElementById('projectNameDisplay').textContent = projectName;
          closeSaveModal();
          updateStatus(`✓ Template saved: ${name}`);
        } else {
          throw new Error('Save failed');
        }
      } catch (error) {
        console.error('Save failed:', error);
        updateStatus('✗ Failed to save template');
        console.log('Template data:', templateData);
      }
    }

    function calculateBounds() {
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      for (const line of lines) {
        for (const p of line.points) {
          minX = Math.min(minX, p.x);
          minY = Math.min(minY, p.y);
          maxX = Math.max(maxX, p.x);
          maxY = Math.max(maxY, p.y);
        }
      }
      return {
        width: Math.ceil(maxX - minX),
        height: Math.ceil(maxY - minY),
        minX, minY, maxX, maxY
      };
    }

    function generatePreviewSVG() {
      if (lines.length === 0) return '<svg></svg>';
      const bounds = calculateBounds();
      const width = bounds.width + 100;
      const height = bounds.height + 100;
      const offsetX = -bounds.minX + 50;
      const offsetY = -bounds.minY + 50;

      let svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">`;
      for (const line of lines) {
        const colors = { cut: '#ff4444', crease: '#4488ff', perforation: '#ff44ff', bleed: '#44ff44' };
        const dashes = { cut: '', crease: '5,5', perforation: '2,3', bleed: '' };

        let path = `M ${line.points[0].x + offsetX} ${line.points[0].y + offsetY}`;
        for (let i = 1; i < line.points.length; i++) {
          path += ` L ${line.points[i].x + offsetX} ${line.points[i].y + offsetY}`;
        }
        if (line.closed) path += ' Z';

        svg += `<path d="${path}" stroke="${colors[line.type]}" stroke-width="2" fill="none" stroke-dasharray="${dashes[line.type]}"/>`;
      }
      svg += '</svg>';
      return svg;
    }

    function exportJSON() {
      const data = {
        version: '2.0',
        name: projectName,
        created: new Date().toISOString(),
        lines,
        bounds: lines.length > 0 ? calculateBounds() : {}
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${projectName.replace(/\s+/g, '-')}-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      updateStatus(`✓ Exported: ${a.download}`);
    }

    function updateStatus(message) {
      document.getElementById('statusMessage').textContent = message;
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'z': undo(); e.preventDefault(); break;
          case 'y': redo(); e.preventDefault(); break;
          case 's': openSaveModal(); e.preventDefault(); break;
          case 'g': toggleSnap(); e.preventDefault(); break;
          case '1': setLineType('cut'); e.preventDefault(); break;
          case '2': setLineType('crease'); e.preventDefault(); break;
          case '3': setLineType('perforation'); e.preventDefault(); break;
          case '4': setLineType('bleed'); e.preventDefault(); break;
        }
      }

      switch(e.key) {
        case 'v': setTool('select'); break;
        case 'h': setTool('hand'); break;
        case 'l': setTool('line'); break;
        case 'r': setTool('rectangle'); break;
        case 'c': setTool('circle'); break;
        case 'p': setTool('polygon'); break;
        case 'Escape': currentPoints = []; render(); break;
        case 'Enter': finishLine(); break;
      }
    });

    // Initialize
    saveHistory();
    render();
    updateStatus('Ready to draw');
  </script>
</body>
</html>
